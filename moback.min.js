/*! mobackSDKJS 2015-09-29 */
!function(a){function b(b,d,e,f,g,h){function i(){if(4===j.readyState){var a=JSON.parse(j.responseText);e(a)}}var j,k;if(a.XMLHttpRequest)j=new XMLHttpRequest;else if(a.ActiveXObject)try{j=new ActiveXObject("Msxml2.XMLHTTP")}catch(l){try{j=new ActiveXObject("Microsoft.XMLHTTP")}catch(l){}}if(!j)return console.log("Giving up :( Cannot create an XMLHTTP instance"),!1;k=h?g:g?JSON.stringify(g):"",j.onreadystatechange=i,j.open(b,d,!0),""!==k?j.setRequestHeader("X-Requested-With","XMLHttpRequest"):j.open(b,d,!0);var m=c.getSession();if(m&&j.setRequestHeader("X-Moback-SessionToken-Key",m),h||j.setRequestHeader("Content-Type","application/json"),f)for(var n in f)j.setRequestHeader(n,f[n]);j.send(k)}var c={},d="",e="",f="https://api.moback.com/",g=null;c.initialize=function(a,b){d=a,e=b},c.showAppKey=function(){return{appKey:d,envKey:e}},c.setAPILocation=function(a){f=a},c.showAPILocation=function(){return{url:f}},c.saveSession=function(){"undefined"!=typeof Storage&&localStorage.setItem("mobackSession",g)},c.getSession=function(){var a;return a="undefined"!=typeof Storage?localStorage.mobackSession:g,a&&"undefined"!=a?a:!1},c.clearSession=function(){"undefined"!=typeof Storage&&localStorage.removeItem("mobackSession"),g=null},c.userMgr=function(){c.objMgr.call(this,"__appUsers");var a=this;this.createUser=function(b){return"Property does not exist"==a.get("userId")||"Property does not exist"==a.get("email")||"Property does not exist"==a.get("password")?void b("userId, email, and password not set"):void(a.id?b("User already created"):a.save(b))},this.login=function(h,i,j){var k=f+"usermanager/api/users/login",l={userId:h,password:i},m={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d};b("POST",k,function(b){b.response.objectId&&b.ssotoken?(a.id=b.response.objectId,g=b.ssotoken,c.saveSession(),a.loginWithSessionToken(g,j)):j(b)},m,l)},this.loginWithSessionToken=function(h,i){g=h,c.saveSession();var j=f+"usermanager/api/users/user",k={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d};b("GET",j,function(b){if(b.responseObject.code&&"1000"==b.responseObject.code){var c=b.user;a.id=c.objectId,a.createFromExistingObject(b.user),i(b.user)}else i(b)},k)},this.getSessionToken=function(){return c.getSession()},this.logout=function(){return g=null,c.clearSession(),delete a.id,a.unsetAll(),"User has been successfully logged out."},this.resetPassword=function(a,c){var g=f+"usermanager/api/users/password/reset",h={userId:a},i={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d};b("POST",g,function(a){c(a)},i,h)},this.deleteUser=function(c){if(g){var h=f+"usermanager/api/users/user",i={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d};b("DELETE",h,function(b){a.logout(),c(b)},i)}else c("Objects does not exist")},this.sendInvite=function(a,c){if(userObjectId){var g=f+"usermanager/api/users/invitation",h={inviteeID:a},i={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d};b("POST",g,function(a){c(a)},i,h)}else c("User object id is not set, please login the user first")}},c.objMgr=function(a){function g(c,g){var h={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d};if(o.id){if(l){var i;i="function"==typeof o.createUser?f+"usermanager/api/users/user":f+"objectmgr/api/collections/"+l+"/"+o.id,b("PUT",i,function(a){g(a)},h,c)}}else{var i;i="function"==typeof o.createUser?f+"usermanager/api/users/signup":f+"objectmgr/api/collections/"+a,b("POST",i,function(a){a.objectId&&(k=a.objectId,o.id=a.objectId,o.createdAt=a.createdAt,o.updatedAt=a.updatedAt),g(a)},h,c)}}function h(a,b){for(var c={},d=0;d<a.length;d++){var e=a[d].name;delete a[d].name,c[e]=a[d]}g(c,function(){o.save(b)})}function i(a){for(var b=0;b<q.length;b++)if(q[b].name==a)return q[b];var c=new j(a);return q.push(c),q[q.length-1]}function j(a){var b={};return b.name=a,b.currentObjects=[],b.addQueue=[],b.removeQueue=[],b}a&&(this.className=a);var k=!1,l=a,m={},n=null,o=this,p=null,q=[],r=[];this.createObject=function(c,g){var h=f+"objectmgr/api/collections/"+a,i={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d};b("POST",h,function(b){b.objectId&&(k=b.objectId,createdAt=b.createdAt,updatedAt=b.updatedAt,l=a),g(b)},i,c)},this.createFromExistingObject=function(a){q=[];for(var b in a)if("createdAt"==b||"updatedAt"==b||"objectId"==b)"objectId"==b?(o.id=a[b],k=a[b]):o[b]=a[b];else if(a[b]&&a[b].__type&&"Pointer"==a[b].__type){var d=new c.objMgr(a[b].className);d.createFromExistingObject(a[b]),o.set(b,d)}else if(a[b]&&a[b].__type&&"Relation"==a[b].__type){for(var e=new j(b),f=0;f<a[b].value.length;f++){var g=new c.objMgr(a[b].value[f].className);g.createFromExistingObject(a[b].value[f]),e.currentObjects.push(g)}q.push(e)}else a[b]&&"__acl"==b?n=new c.aclMgr(a[b]):o.set(b,a[b])},this.set=function(a,b){var c="";if("parent"==a)p=b,c="Parent set";else if(b&&"undefined"!=typeof b.getValue&&0!=b.getValue()){var d=b.getValue();m[a]=d,c="Property set"}else m[a]=b,c="Property set";return c},this.setACL=function(a){var b="";return a?(n=a,b="ACL for object set"):b="ACL object missing",b},this.getACL=function(){return n?n:null},this.get=function(a){return"parent"==a?p:m[a]?m[a]:null},this.unset=function(a){return"parent"==a?p=null:(m[a]=null,delete m[a]),"item "+a+" unset"},this.unsetAll=function(){return m={},"all items unset"},this.save=function(a){var b={};if(q.length>0){for(var c=[],d=[],e=0;e<q.length;e++){for(var f=q[e].name,i=[],j=[],k=0;k<q[e].removeQueue.length;k++){var l={__type:"Pointer"};l.objectId=q[e].removeQueue[k].id,l.className=q[e].removeQueue[k].className,j.push(l)}if(j.length>0){q[e].removeQueue=[];var r={};r.objects=j,r.__op="RemoveRelation",r.name=f,d.push(r)}for(var k=0;k<q[e].addQueue.length;k++){var l={__type:"Pointer"};l.objectId=q[e].addQueue[k].id,l.className=q[e].addQueue[k].className,i.push(l)}if(i.length>0){var s={};s.objects=i,s.__op="AddRelation",s.name=f,c.push(s)}}if(d.length>0)return void h(d,a);if(c.length>0){for(var e=0;e<c.length;e++){var f=c[e].name;delete c[e].name,b[f]=c[e]}for(var e=0;e<q.length;e++)if(q[e].addQueue.length>0){var t=q[e].addQueue.splice(0,q[e].addQueue.length);q[e].currentObjects=q[e].currentObjects.concat(t)}}}if(null!=p){if(!p.id)return void p.save(function(){o.save(a)});b.parent={__type:"Pointer",objectId:p.id,className:p.className}}for(var u in m)null!==m[u]&&(m[u].id?b[u]={__type:"Pointer",objectId:m[u].id,className:m[u].className}:m[u].objectId?b[u]={__type:"Pointer",objectId:m[u].objectId,className:m[u].className}:b[u]=m[u]);n&&(b.__acl=n.getACL()),g(b,a)},this.fetch=function(a){var c=f+"objectmgr/api/collections/"+l+"/"+o.id;if(r.length>0){for(var g="",h=0;h<r.length;h++)g+=r[h]+",";c=c+"?include="+g}var i={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d};b("GET",c,function(b){o.createFromExistingObject(b),a(b)},i)},this.include=function(a){return a?(r.push(a),"Add include for "+a):"value has to be set"},this.remove=function(a){if(k){var c=f+"objectmgr/api/collections/"+l+"/"+o.id,g={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d};b("DELETE",c,function(b){a(b),delete o.id,o.unsetAll()},g)}else a("Objects does not exist")},this.relation=function(a){o.unset(a);var b={},c=i(a);return b.add=function(a){return c.addQueue.push(a),"item relation added"},b.remove=function(a){for(var b=!1,d=0;d<c.addQueue.length;d++)if(c.addQueue[d].id)return c.addQueue.splice(d,1),b=!0,"item relation removed";for(var d=0;d<c.currentObjects.length;d++)if(c.currentObjects[d].id)return c.currentObjects.splice(d,1),b=!0,c.removeQueue.push(a),"item relation removed";return"item could not be found"},b.getSaved=function(){return c.currentObjects},b.inspect=function(){return q},b}},c.Date=function(a){var b=new Date(a).toISOString();this.dateObj={__type:"Date",iso:b}},c.Date.prototype.getValue=function(){return this.dateObj},c.Date.prototype.setDate=function(a){var b=new Date(a).toISOString();this.dateObj={__type:"Date",iso:b}},c.GeoPoint=function(a,b){this.geoObj={__type:"GeoPoint",lat:a,lon:b}},c.GeoPoint.prototype.getValue=function(){return this.geoObj},c.GeoPoint.prototype.setGeoPoint=function(a,b){this.geoObj={__type:"GeoPoint",lat:a,lon:b}},c.aclMgr=function(a){var b={};b=a?a:{globalRead:!0,globalWrite:!0,userRead:[],userWrite:[],groupRead:[],groupWrite:[]},this.setPublicWritePermission=function(a){return b.globalWrite=a,"Public Permission set"},this.setPublicReadPermission=function(a){return b.globalRead=a,"Public Permission set"},this.setRoleWritePermission=function(a,c){for(var d=0;d<b.groupWrite.length;d++)if(b.groupWrite[d].roleName==a)return c?"Role already in the permission list":(b.groupWrite.splice(d,1),"Role write permission removed");return c?(b.groupWrite.push({roleName:a}),"Role permission added"):"Could not find role permission to remove"},this.setRoleReadPermission=function(a,c){for(var d=0;d<b.groupRead.length;d++)if(b.groupRead[d].roleName==a)return c?"Role already in the permission list":(b.groupRead.splice(d,1),"Role read permission removed");return c?(b.groupRead.push({roleName:a}),"Role permission added"):"Could not find role permission to remove"},this.setUserWritePermission=function(a,c){for(var d=0;d<b.userWrite.length;d++)if(b.userWrite[d].userObjectId==a)return c?"User already in the permission list":(b.userWrite.splice(d,1),"User write permission removed");return c?(b.userWrite.push({userObjectId:a}),"User permission added"):"Could not find User permission to remove"},this.setUserReadPermission=function(a,c){for(var d=0;d<b.userRead.length;d++)if(b.userRead[d].userObjectId==a)return c?"User already in the permission list":(b.userRead.splice(d,1),"User read permission removed");return c?(b.userRead.push({userObjectId:a}),"User permission added"):"Could not find User permission to remove"},this.getACL=function(){return b},this.getInfo=function(){return JSON.stringify(b)}},c.roleMgr=function(a){c.objMgr.call(this,"__roleSettings");var b=this;a&&b.set("roleName",a),this.createRole=function(a){return"Property does not exist"==b.get("roleName")?void a("role name is not set"):void(b.id?a("Role already created"):b.save(a))},this.users=function(){return b.relation("assigned")}},c.queryMgr=function(a){function g(){var a="where=";if(j.length>0){var b="";if(1==j.length)b+=encodeURIComponent(JSON.stringify(j[0]));else{var c={};c["$"+p]=j,b+=encodeURIComponent(JSON.stringify(c))}a+=""!=b?b:encodeURIComponent("{}")}else a+=encodeURIComponent("{}");if(k&&(a=a+"&limit="+k),l&&(a=a+"&skip="+l),m&&(a=a+"&order="+m),n&&(a=a+"&keys="+n),o.length>0){for(var d="",e=0;e<o.length;e++)d+=o[e]+",";a=a+"&include="+d}return"where="==a?"":a}var h=f+"objectmgr/api/",i=a||!1,j=[],k=!1,l=!1,m=!1,n=!1,o=[],p="and";this.setTable=function(a){return i=a,"Query object has been changed to table "+a},this.fetch=function(a){if(i){var f=g(),j=h+"collections/"+i+"?"+f,k={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d};b("GET",j,function(b){if(b.results){for(var d=[],e=0;e<b.results.length;e++){var f=new c.objMgr(i);f.createFromExistingObject(b.results[e]),d.push(f)}a(d)}else a(b)},k)}else a("Query object is not set, please set a query object first")},this.fetchSingle=function(a,f){if(i){var g="";if(o.length>0){for(var j="",k=0;k<o.length;k++)j+=o[k]+",";g=g+"?include="+j}var l=h+"collections/"+i+"/"+a+g,m={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d};b("GET",l,function(a){var b=new c.objMgr(i);b.createFromExistingObject(a),f(b)},m)}else f("Query object is not set, please set a query object first")},this.getCount=function(a){if(i){var c=g(),f=h+"collections/"+i+"?op=count";""!=c&&(f+="&"+c);var j={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d};b("GET",f,function(b){a(b.count?b.count:0)},j)}else a("Query object is not set, please set a query object first")},this.equalTo=function(a,b){if(a&&b){var c={};return c[a]=b,j.push(c),"Added filter: eq "+a+" : "+b}return"Key and value are required"},this.notEqualTo=function(a,b){if(a&&b){var c={};return c[a]={$ne:b},j.push(c),"Added filter: neq "+a+" : "+b}return"Key and value are required"},this.greaterThan=function(a,b){if(a&&b){var c={};return c[a]={$gt:b},j.push(c),"Added filter: gt "+a+" : "+b}return"Key and value are required"},this.lessThan=function(a,b){if(a&&b){var c={};return c[a]={$lt:b},j.push(c),"Added filter: lt "+a+" : "+b}return"Key and value are required"},this.greaterThanOrEqualTo=function(a,b){if(a&&b){var c={};return c[a]={$gte:b},j.push(c),"Added filter: gte "+a+" : "+b}return"Key and value are required"},this.lessThanOrEqualTo=function(a,b){if(a&&b){var c={};return c[a]={$lte:b},j.push(c),"Added filter: lte "+a+" : "+b}return"Key and value are required"},this.applyRegex=function(a,b){if(a&&b){var c={};return c[a]={$regex:b},j.push(c),"Added filter: regex "+a+" : "+b}return"Key and value are required"},this.exists=function(a){if(a){var b={};return b[a]={$exists:!0},j.push(b),"Added filter: exists "+a}return"value for exists has to be set"},this.doesNotExist=function(a){if(a){var b={};return b[a]={$exists:!1},j.push(b),"Added filter: does not exist "+a}return"value for does not exist has to be set"},this.near=function(a,b,c,d,e){if(a&&b&&c){var f={__type:"GeoPoint",lat:b,lon:c},g={};if(g[a]={$near:f},d){var h="$maxDistance";e&&("km"==e?h="$maxDistanceInKms":"mi"==e&&(h="$maxDistanceInMiles")),g[a][h]=d}return j.push(g),"Added filter: near "+a+" : "+f}return"Key and geopoints are required"},this.within=function(a,b){if(a&&b){if(b.length<2)return"At least two geopoints are required";for(var c=[],d=0;d<b.length;d++)c.push(b[d].getValue());var e={};return e[a]={$within:{$box:c}},j.push(e),"Added filter: within "+a+" : "+b}return"Key and geopoints are required"},this.getFilters=function(){return j},this.resetFilters=function(){return j=[],"filters reset"},this.limit=function(a){return a?(k=a,"Set limit to "+a):"Limit value required"},this.skip=function(a){return a?(l=a,"Set skip to "+a):"Limit value required"},this.queryMode=function(a){return"and"==a||"or"==a?(p=a,"Set query mode to "+a):"queryMode has to be 'and' or 'or'"},this.ascending=function(a){return a?(m=a,"Set ascending mode for "+a):"value has to be set"},this.descending=function(a){return a?(m="-"+a,"Set descending mode for "+a):"value has to be set"},this.include=function(a){return a?(o.push(a),"Add include for "+a):"value has to be set"},this.select=function(a){if(a){if("string"==typeof a)n=a;else{for(var b="",c=0;c<a.length;c++)b=b+a[c]+",";n=b}return"Restrict columns only to "+n}return"value has to be set"},this.containedIn=function(a,b){if(b){var c={};return c[a]={$in:b},j.push(c),"Filtered "+a+" column with "+b}return"value has to be set"},this.notContainedIn=function(a,b){if(b){var c={};return c[a]={$nin:b},j.push(c),"Filtered "+a+" column without "+b}return"value has to be set"},this.containsAll=function(a,b){if(b){var c={};return c[a]={$all:b},j.push(c),"Filtered "+a+" now has to contain "+b}return"array has to be set"},this.dropTable=function(a){if(i){var c=h+"schema/"+i,f={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d};b("DELETE",c,function(b){a(b)},f)}else a("Table does not exist, please check the table name")}},c.notificationMgr=function(){this.sendSingleUserNotification=function(a,c,g){var h={receiverId:a,data:{alert:c}},i=f+"notificationmanager/api/alerts/push",j={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d};b("POST",i,function(a){g(a)},j,h)},this.sendAllNotification=function(a,c){var g={data:{alert:a}};g.channels=["__default"];var h=f+"notificationmanager/api/alerts/push",i={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d};b("POST",h,function(a){c(a)},i,g)},this.sendCustomEmail=function(a,c){var g=f+"notificationmanager/api/emails/email/custom",h={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d};b("POST",g,function(a){c(a)},h,a)}},c.fileMgr=function(a,c){var g=!1;this.save=function(h,i){var j=new FormData;console.log(a),c?j.append("file",a,c):j.append("file",a);var k=f+"filemanager/api/files/upload",l={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d,"X-Moback-SessionToken-Key":h};b("PUT",k,function(a){a.url&&a.name&&(g=a.url,c=a.name),i(a)},l,j,!0)},this.getValue=function(){if(g){var a={__type:"File"};return a.name=c,a.url=g,a}return!1},this.getName=function(){return c?c:"File name not available"},this.getUrl=function(){return g?g:"File URL not available"},this.removeFile=function(a,h){var i=f+"filemanager/api/files/file/"+c,j={"X-Moback-Environment-Key":e,"X-Moback-Application-Key":d,"X-Moback-SessionToken-Key":a};b("DELETE",i,function(a){c=!1,g=!1,h(a)},j)}},"undefined"==typeof Moback&&(a.Moback=c)}(window);